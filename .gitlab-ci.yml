stages:
  - build
  - test

variables:
  #TAG_PRODUCER: $CI_REGISTRY_IMAGE/$CI_COMMIT_REF_NAME:producer
  TAG_CONSUMER: $CI_REGISTRY_IMAGE/consumer:latest
  TAG_PRODUCER: $CI_REGISTRY_IMAGE/producer:latest

cache:
  key: ${CI_COMMIT_REF_SLUG}   
  paths:     
    - .m2/repository/
    - target/*.jar
    - target/*.json

build_maven:
  image: maven:latest 
  variables:   
    MAVEN_CLI_OPTS: "-s .m2/settings.xml --batch-mode"
    MAVEN_OPTS: "-Dmaven.repo.local=.m2/repository" 
  stage: build     
  artifacts:     
    paths:
      - target/kafka-model-schema-connector-1.0-SNAPSHOT-jar-with-dependencies.jar
      - target/config.json
      - target/consumer-config.json
  script:
    - mvn $MAVEN_CLI_OPTS -Dmaven.wagon.http.ssl.insecure=true package

build_docker:
  image: docker:stable
  stage: test
  services:
    - docker:stable-dind
  script:
      - docker build -t $TAG_PRODUCER -f Dockerfile.producer .
      - docker build -t $TAG_CONSUMER -f Dockerfile.consumer .
      - docker login -u gitlab-ci-token -p $CI_BUILD_TOKEN $CI_REGISTRY
      - echo $TAG_LATEST
      - docker push $TAG_PRODUCER
      - docker push $TAG_CONSUMER




